<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Reportes de Proyectos - Repositorio SENA</title>
    <!-- Favicons -->
    <link href="{{ url_for('static', filename='img/logoSena.png') }}" rel="icon">
    <link href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" rel="apple-touch-icon">

    <!-- Vendor CSS Files -->
    <link href="{{ url_for('static', filename='vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/aos/aos.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/swiper/swiper-bundle.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/glightbox/css/glightbox.min.css') }}" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
            <a href="{{ url_for('index') }}" class="logo d-flex align-items-center me-auto me-xl-0">
                <h1 class="sitename" style="color: #ffffff;">Repositorio SENA</h1>
            </a>
            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="{{ url_for('index') }}">Inicio</a></li>
                    <li><a href="{{ url_for('comunidad') }}">Comunidad</a></li>
                    {% if usuario['rol_id'] == 3 %}
                    <li><a href="{{ url_for('estadisticas') }}">Estadísticas</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('top_usuarios') }}">Top</a></li>
                    <li><a href="{{ url_for('reportes') }}">Reportes</a></li>
                    <li><a href="{{ url_for('equipo') }}">Equipo</a></li>
                    <li class="dropdown"><a href="#"><span>Gestión</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
                        <ul>
                            <li><a href="{{ url_for('almacenamiento') }}">Almacenamiento</a></li>
                            <li><a href="{{ url_for('consulta') }}">Consultar</a></li>

                        </ul>
                    </li>
                    <li><a href="{{ url_for('contacto') }}">Contacto</a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>
            <!--imagenes-->
      <div class="profile-menu-wrapper position-relative">
        <img src="{% if usuario and usuario['foto_perfil'] %}{{ usuario['foto_perfil'] }}{% else %}{{ url_for('static', filename='img/default-profile.png') }}{% endif %}"
             alt="Perfil"
             class="profile-img"
             id="profileToggle"
             style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;">
      
        <div id="profileMenu" class="profile-menu d-none">
          <ul class="list-unstyled m-0">
            <li><a href="{{ url_for('perfil') }}">Mi perfil</a></li>
            <li><a href="{{ url_for('configuracion') }}">Configuración</a></li>
            <li><a href="{{ url_for('logout') }}">Cerrar sesión</a></li>
            {% if usuario['rol_id'] == 3 %}
              <li><a href="{{ url_for('asignar') }}">Asignar roles</a></li>
            {% endif %}
          </ul>
        </div>
      </div> 
<!--fin imagenes-->
    </header>

    <main id="main" class="main-page reportes">
        <div class="container py-5">
            <h1 class="text-center mb-5">Reportes de Proyectos</h1>
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Búsqueda de Proyectos</h5>
                                <div class="d-flex gap-2">
                                    <div class="input-group">
                                        <input type="text" id="busqueda" class="form-control" placeholder="Buscar...">
                                        <button class="btn btn-primary" type="button" onclick="buscarProyectos()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>                            
                            <div id="resultadosBusqueda" class="mt-4">
                                <!-- Los resultados se mostrarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mb-4 d-flex align-items-end justify-content-end gap-2">
                <button class="btn btn-outline-danger" onclick="exportarPDF()">Exportar a PDF</button>
              </div>        
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaProyectos">
                                    <thead>
                                        <tr>
                                            <th>Título</th>
                                            <th>Autores</th>
                                            <th>Fecha de Subida</th>
                                            <th>Categorías</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTabla">
                                        {% for proyecto in proyectos %}
                                        <tr>
                                            <td>{{ proyecto.titulo }}</td>
                                            <td>{{ proyecto.autores or 'Sin autor' }}</td>
                                            <td>{{ proyecto.fecha_subida[:10] if proyecto.fecha_subida else 'No especificada' }}</td>
                                            <td>{{ proyecto.categorias or 'Sin categoría' }}</td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center">No hay proyectos para mostrar</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Vendor JS Files -->
    <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/aos/aos.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/glightbox/js/glightbox.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/purecounter/purecounter_vanilla.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/swiper/swiper-bundle.min.js') }}"></script>

    <!-- Template Main JS File -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Función para buscar proyectos por autor
        function buscarProyectos() {
            const terminoBusqueda = document.getElementById('busqueda').value.trim().toLowerCase();
            const filas = document.querySelectorAll('#cuerpoTabla tr');
            let resultadosEncontrados = 0;
            
            // Ocultar el mensaje de "No hay proyectos" si existe
            const mensajeNoProyectos = document.querySelector('#cuerpoTabla .no-projects');
            if (mensajeNoProyectos) {
                mensajeNoProyectos.style.display = 'none';
            }

            // Eliminar mensaje de búsqueda anterior si existe
            const mensajeAnterior = document.getElementById('mensajeBusqueda');
            if (mensajeAnterior) {
                mensajeAnterior.remove();
            }

            // Si no hay término de búsqueda, mostrar todos los proyectos
            if (!terminoBusqueda) {
                filas.forEach(fila => {
                    if (!fila.classList.contains('no-projects')) {
                        fila.style.display = '';
                    }
                });
                return;
            }

            // Buscar por autor (segunda columna, índice 1)
            filas.forEach(fila => {
                if (fila.cells && fila.cells[1]) {
                    const textoAutor = fila.cells[1].textContent.toLowerCase();
                    if (textoAutor.includes(terminoBusqueda)) {
                        fila.style.display = '';
                        resultadosEncontrados++;
                    } else {
                        fila.style.display = 'none';
                    }
                }
            });

            // Mostrar mensaje si no hay resultados
            if (resultadosEncontrados === 0) {
                const cuerpoTabla = document.getElementById('cuerpoTabla');
                const mensaje = document.createElement('tr');
                mensaje.id = 'mensajeBusqueda';
                mensaje.innerHTML = `
                    <td colspan="5" class="text-center">
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No se encontraron proyectos del autor: "${terminoBusqueda}"
                        </div>
                    </td>
                `;
                cuerpoTabla.appendChild(mensaje);
            }
        }

        // Permitir búsqueda al presionar Enter
        document.getElementById('busqueda').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                buscarProyectos();
            }
        });

        // Mostrar todos los proyectos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página de reportes cargada');
            
            // Configurar el botón de búsqueda
            document.querySelector('.btn-primary').addEventListener('click', buscarProyectos);
            
            // Configurar el botón para limpiar búsqueda
            const btnLimpiar = document.createElement('button');
            btnLimpiar.className = 'btn btn-outline-secondary';
            btnLimpiar.type = 'button';
            btnLimpiar.innerHTML = '<i class="bi bi-x-circle"></i>';
            btnLimpiar.title = 'Limpiar búsqueda';
            btnLimpiar.onclick = function() {
                document.getElementById('busqueda').value = '';
                buscarProyectos();
            };
            
            // Agregar el botón de limpiar al grupo de entrada
            const inputGroup = document.querySelector('.input-group');
            inputGroup.appendChild(btnLimpiar);
        });    
        // Exportar tabla a PDF
        function exportarPDF() {
            try {
                // Check if jsPDF is loaded
                if (typeof jspdf === 'undefined') {
                    throw new Error('No se pudo cargar la biblioteca jsPDF');
                }

                // Create a new jsPDF instance
                const doc = new jspdf.jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(40);
                doc.text('Reporte de Proyectos', 14, 22);
                
                // Get table data
                const headers = [];
                document.querySelectorAll('#tablaProyectos thead th').forEach(th => {
                    headers.push(th.textContent.trim());
                });
                
                const rows = [];
                document.querySelectorAll('#tablaProyectos tbody tr').forEach(tr => {
                    if (tr.style.display !== 'none') {
                        const row = [];
                        tr.querySelectorAll('td').forEach(td => {
                            row.push(td.textContent.trim());
                        });
                        rows.push(row);
                    }
                });
                
                if (rows.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                // Add table using autoTable
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 30,
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        overflow: 'linebreak',
                        lineWidth: 0.1,
                        lineColor: [0, 0, 0],
                        textColor: [0, 0, 0],
                        font: 'helvetica',
                        fontStyle: 'normal',
                        fillColor: [255, 255, 255],
                        cellWidth: 'wrap'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { top: 30 }
                });
                
                // Save the PDF
                doc.save('reporte_proyectos.pdf');
                
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                alert('Error al generar el PDF: ' + error.message);
            }
        }
    </script>

</body>
</html>
